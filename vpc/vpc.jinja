{% set deployment = env["deployment"]%}

resources:
- name: {{ deployment }}-vpc
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: false

{% for i in range(properties['subnets']| length) %}    
{% set subnet = properties['subnets'][i] %}
- type: compute.v1.subnetwork
  name: {{ subnet['region'] }}-{{ i }}
  properties:
    region: {{ subnet['region'] }}
    ipCidrRange: {{ subnet['ip_cidr'] }}
    network: $(ref.{{ deployment }}-vpc.selfLink)
    metadata: 
      dependsOn: {{ deployment }}-vpc
 {% endfor %}

outputs:
  - name: subnet
    value: $(ref.{{ properties['subnets'][0]['region'] }}-{{ 0 }}.selfLink)
  - name: network
    value: $(ref.{{ deployment }}-vpc.selfLink)
